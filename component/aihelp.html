<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chat Assistance | HealthyBe</title>
    <link rel="icon" href="image/favlogo.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <style>
      body{font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial}
      /* make sure long words wrap and preformatted text preserves spacing */
      .message-text{overflow-wrap:anywhere;word-break:break-word;white-space:pre-wrap}
      /* nicer scrollbar for chat window */
      #chatWindow::-webkit-scrollbar{width:10px}
      #chatWindow::-webkit-scrollbar-thumb{background:linear-gradient(180deg,#6366f1,#06b6d4);border-radius:9999px}
      /* mobile safe-area for fixed bottom input */
      @media (max-width: 768px){
        body{padding-bottom:calc(env(safe-area-inset-bottom) + 76px)}
        #chatWindow{padding-bottom:calc(env(safe-area-inset-bottom) + 140px) !important}
        form#chatForm{left:0;right:0;padding-left:12px;padding-right:12px;background:linear-gradient(90deg, rgba(2,6,23,0.6), rgba(15,23,42,0.6));}
        /* make the floating bar look like a card */
        form#chatForm{border-top-left-radius:14px;border-top-right-radius:14px;box-shadow:0 -8px 24px rgba(2,6,23,0.6);z-index:60}
      }
    </style>
</head>
  <body class="bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 text-white min-h-screen flex flex-col">

    <!-- Chat Section -->
    <main class="flex-1 p-4 md:p-6">
      <div class="w-full h-[calc(100vh-72px)] bg-slate-800/70 rounded-2xl shadow-2xl p-4 md:p-6 border border-white/5 flex flex-col">
        <header class="flex items-center justify-between mb-3">
          <div class="flex items-center gap-3">
            <div class="w-12 h-12 rounded-full bg-gradient-to-br from-blue-500 to-teal-400 flex items-center justify-center text-white text-lg"><i class="fa-solid fa-robot"></i></div>
            <div>
              <h2 class="text-lg md:text-2xl font-bold">AI Assistance</h2>
              <p class="text-xs md:text-sm text-slate-300">Ask about symptoms, medicines, or upload a prescription for tailored suggestions.</p>
            </div>
          </div>
          <div class="hidden md:flex items-center text-sm text-slate-400">Powered by Gemini â€¢ <span id="status" class="ml-2 text-emerald-400">Online</span></div>
        </header>

        <div id="chatWindow" class="w-full flex-1 bg-slate-900/40 rounded-lg p-4 overflow-y-auto text-sm text-blue-100 border border-blue-700/10" style="padding-bottom:140px">
          <!-- messages appended here -->
        </div>
        <!-- Floating input for mobile, inline for desktop -->
        <div class="w-full">
          <form id="chatForm" class="w-full flex items-center gap-3 p-3 bg-transparent md:bg-transparent fixed md:static bottom-0 left-0 md:left-auto md:bottom-auto md:p-0" style="backdrop-filter: blur(6px);">
            <div class="flex items-center gap-2 w-auto md:mr-2">
              <label for="prescriptionInput" class="cursor-pointer flex items-center justify-center bg-green-600 hover:bg-green-700 text-white rounded-md w-12 h-12 text-xl transition shadow-lg" title="Upload Prescription">
                <i class="fa fa-plus"></i>
              </label>
              <input type="file" id="prescriptionInput" accept="image/*,application/pdf" class="hidden" />
            </div>

            <textarea id="chatInput" rows="1" placeholder="Ask me anything about your health..." class="flex-1 rounded-full p-3 bg-slate-700/90 text-white border border-blue-700/20 focus:outline-none focus:ring-2 focus:ring-blue-400 resize-none message-text" required style="max-height:180px"></textarea>

            <button type="submit" class="bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500 hover:from-blue-700 hover:to-pink-700 text-white font-bold w-12 h-12 rounded-full shadow-lg flex items-center justify-center">
              <i class="fa fa-paper-plane"></i>
            </button>
          </form>
        </div>
      </div>
    </main>

    <script type="module">
    import { GoogleGenAI } from 'https://cdn.jsdelivr.net/npm/@google/genai@latest/+esm';
    const key = "AIzaSyAgzCAQ2fSI7CVcF5295WFAbeZEEC5T0-s";
    const ai = new GoogleGenAI({ apiKey: key });

  const chatForm = document.getElementById('chatForm');
  const chatInput = document.getElementById('chatInput');
    const chatWindow = document.getElementById('chatWindow');
    const prescriptionInput = document.getElementById('prescriptionInput');

  let prescriptionText = '';

    prescriptionInput.onchange = async () => {
      const file = prescriptionInput.files[0];
      if (!file) return;
      prescriptionText = await analyzePrescription(file);
      chatWindow.innerHTML += `
        <div class="flex justify-end mb-3">
            <div class="max-w-[75%] bg-green-200 text-gray-900 p-3 rounded-2xl font-semibold shadow-lg message-text">
                <span class="italic">${prescriptionText}</span>
                <div class="text-[0.7rem] text-gray-600 mt-1 text-right">${new Date().toLocaleTimeString()}</div>
            </div>
        </div>
      `;
      const aiPrompt = `Based on this prescription: ${prescriptionText}, give a concise health suggestion and a personalized diet plan.`;
      const aiResponse = await getAiSuggestion(aiPrompt);
      chatWindow.innerHTML += `
        <div class="flex justify-start mb-3">
            <div class="max-w-[75%] bg-blue-200 text-gray-900 p-3 rounded-2xl font-semibold shadow-lg">
                <div class="message-text"><strong>Summary:</strong> ${aiResponse.suggestion}</div>
                <div class="message-text"><strong>Diet Plan:</strong> ${aiResponse.diet}</div>
                <div class="text-[0.7rem] text-gray-600 mt-1">${new Date().toLocaleString()}</div>
            </div>
        </div>
      `;
      chatWindow.scrollTop = chatWindow.scrollHeight;
    };

    function cleanAndLimitAnswer(text, maxWords = 300) {
      let cleaned = text.replace(/\*/g, '');
      const words = cleaned.split(/\s+/);
      if (words.length > maxWords) {
        cleaned = words.slice(0, maxWords).join(' ') + '...';
      }
      return cleaned;
    }

    function markdownToHtml(md) {
      return md
        .replace(/\n/g, '<br>')
        .replace(/^- (.*)$/gm, '<li>$1</li>')
        .replace(/\n<li>/g, '<ul><li>')
        .replace(/<\/li>\n/g, '</li></ul>');
    }

    function analyzePrescription(file) {
      return new Promise((resolve) => {
        setTimeout(() => {
          resolve('Detected: Diabetes, Metformin 500mg, Morning & Night');
        }, 1200);
      });
    }

    async function getAiSuggestion(prompt) {
      const response = await ai.models.generateContent({
        model: 'gemini-2.0-flash-001',
        contents: [{ role: 'user', parts: [{ text: prompt }] }]
      });
      let aiText = "";
      if (response?.candidates?.[0]?.content?.parts?.[0]?.text) {
        aiText = response.candidates[0].content.parts[0].text.trim();
      } else {
        aiText = "Sorry, I couldn't understand that.";
      }
      let suggestion = aiText, diet = '';
      const dietIdx = aiText.toLowerCase().indexOf('diet plan:');
      if (dietIdx !== -1) {
        suggestion = aiText.slice(0, dietIdx).trim();
        diet = aiText.slice(dietIdx + 10).trim();
      }
      suggestion = cleanAndLimitAnswer(suggestion);
      diet = cleanAndLimitAnswer(diet);
      return { suggestion, diet };
    }

    async function sendMessage(message, isSystem = false) {
        if (!isSystem) {
          chatWindow.innerHTML += `
            <div class="flex justify-end mb-3">
              <div class="max-w-[75%] bg-green-200 text-gray-900 p-3 rounded-2xl font-semibold shadow-lg">
                <div class="message-text">${message}</div>
                <div class="text-[0.7rem] text-gray-600 mt-1 text-right">${new Date().toLocaleTimeString()}</div>
              </div>
            </div>
          `;
          chatInput.value = '';
        }
        try {
            let prompt = message;
            if (prescriptionText && !isSystem) {
              prompt += `\nPrescription details: ${prescriptionText}`;
            }
            const response = await ai.models.generateContent({
                model: 'gemini-2.0-flash-001',
                contents: [{ role: 'user', parts: [{ text: prompt }] }]
            });
            let aiText = "";
            if (response?.candidates?.[0]?.content?.parts?.[0]?.text) {
                aiText = response.candidates[0].content.parts[0].text.trim();
            } else {
                aiText = "Sorry, I couldn't understand that.";
            }
            const structured = {
                answer: markdownToHtml(cleanAndLimitAnswer(aiText)),
                timestamp: new Date().toLocaleString(),
                source: 'Gemini AI'
            };
            chatWindow.innerHTML += `
              <div class="flex justify-start mb-3">
                <div class="max-w-[75%] bg-blue-200 text-gray-900 p-3 rounded-2xl font-semibold shadow-lg">
                  <div class="message-text">${structured.answer}</div>
                  <div class="text-[0.7rem] text-gray-600 mt-1">${structured.source} | ${structured.timestamp}</div>
                </div>
              </div>
            `;
            chatWindow.scrollTop = chatWindow.scrollHeight;
        } catch (error) {
            chatWindow.innerHTML += `
              <div class="flex justify-start mb-3">
                <div class="max-w-[75%] bg-red-500 text-white p-3 rounded-2xl font-semibold shadow-lg message-text">
                  AI Error: ${error.message}
                </div>
              </div>
            `;
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }
    }

    chatForm.onsubmit = (e) => {
        e.preventDefault();
        const message = chatInput.value.trim();
        if (message) sendMessage(message);
    };

    // Auto-resize textarea for better mobile UX
    const resizeTextarea = () => {
      chatInput.style.height = 'auto';
      chatInput.style.height = Math.min(chatInput.scrollHeight, 200) + 'px';
    };
    chatInput.addEventListener('input', resizeTextarea);
    window.addEventListener('resize', resizeTextarea);
    
    // Ensure chat window bottom padding matches the input bar height (for mobile)
    const adjustForInputBar = () => {
      const form = document.getElementById('chatForm');
      const rect = form.getBoundingClientRect();
      const extra = 20; // small gap
      chatWindow.style.paddingBottom = (rect.height + extra) + 'px';
    };
    // Run after load and on resize/input changes
    setTimeout(adjustForInputBar, 200);
    window.addEventListener('resize', adjustForInputBar);
    // when focusing input, scroll chat to bottom so latest messages are visible
    chatInput.addEventListener('focus', () => { setTimeout(()=>{ chatWindow.scrollTop = chatWindow.scrollHeight }, 120) });
    </script>
</body>
</html>
